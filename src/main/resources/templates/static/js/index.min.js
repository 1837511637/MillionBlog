$("body").on("click",".ajaxload .next a",function(){aln();});
function aln() {
    var query = '.ajaxload .next a';
    var url = '/blog/getFindAll';
    $(query).addClass('loading').text("正在加载");
    var data = getData(query);
    if (url) {
        $.ajax({
            url: url,
            data : data,
            type : "post",
            error: function () {
                alert('请求失败，请检查网络并重试或者联系管理员');
                $(query).removeAttr("class").text("");
                return false
            }, success: function (result) {
                //查看更多按钮失去样式
                $(query).removeAttr("class");
                if(result.success) {
                    var list = result.dataWrapper.datas;
                    var param = result.dataWrapper.query;
                    for(var i in list) {
                        var blog = list[i];
                        var html = '<article class="post">\n' +
                            '                    <h2 class="post-title">\n' +
                            '                        <a href="/blog/' + blog.id + '.html">'+ blog.title +'</a>\n' +
                            '                    </h2>\n' +
                            '                    <ul class="post-meta">\n' +
                            '                        <li>'+ blog.createtime +'</li>\n' +
                            '                        <li>'+ blog.type +'</li>\n' +
                            '                        <li>'+ blog.evalnum +'</li>\n' +
                            '                        <li>'+ blog.viewnum +'</li>\n' +
                            '                    </ul>\n' +
                            '                    <div class="post-content">\n';
                        if(blog.img != null && blog.img != '') {
                            html = html + '      <p class="thumb"><img src="'+ blog.img +'"/></p>\n';
                        }
                        html = html + '          <p>'+ blog.content +'</p>\n' +
                            '                        <p class="more">\n' +
                            '                            <a href="/blog/'+ blog.id +'.html" title="'+ blog.title +'">- 阅读全文 -</a>\n' +
                            '                        </p>\n' +
                            '                    </div>\n' +
                            '                </article>';
                        $('.ajaxload').before($(html));
                    }
                    if(result.page < result.totalpage) {
                        $(query).text("查看更多")
                            .attr("data-page", result.page + 1)
                            .attr("href", "javascritp:void(0);")
                            .attr("data-type", query.typeid)
                            .attr("data-label", query.labelid)
                            .attr("data-key", query.keyword);
                    } else {
                        $(query).remove();
                        $('.ajaxload .next').text('没有更多文章了')
                    }
                } else {
                    $(query).remove();
                    $('.ajaxload .next').text('没有更多文章了')
                }
            }
        })
    }
}
function getData(query) {
    var data = {};
    //<a href="javascritp:void(0);" data-key="${query.keyword!}" data-type="${query.typeid}" data-label="${query.labelid}" data-page="${page}">查看更多</a>
    var page = $(query).attr("data-page");
    var typeid = $(query).attr("data-type");
    var labelid = $(query).attr("data-label");
    var keyword = $(query).attr("data-key");
    if(page!=null && page > 0) {
        data.page = page;
    }
    if(typeid!=null && typeid > 0) {
        data.typeid = typeid;
    }
    if(labelid!=null && labelid > 0) {
        data.labelid = labelid;
    }
    if(keyword!=null && keyword!='') {
        data.keyword = keyword;
    }
    return data;
}
